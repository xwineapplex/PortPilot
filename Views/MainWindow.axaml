<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="using:PortPilot_Project.ViewModels"
    xmlns:p="clr-namespace:PortPilot_Project.Properties"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        mc:Ignorable="d" d:DesignWidth="900" d:DesignHeight="600"
        MinWidth="720" MinHeight="550"
        x:Class="PortPilot_Project.Views.MainWindow"
        x:DataType="vm:MainWindowViewModel"
        Icon="/Assets/avalonia-logo.ico"
    Title="{x:Static p:Resources.Main_Title}">
        <!-- 已移除強制背景色，現在會自動適應系統深色/淺色主題 -->

    <Design.DataContext>
        <vm:MainWindowViewModel/>
    </Design.DataContext>

    <Grid RowDefinitions="*,Auto">
        <Grid.Styles>
            <Style Selector="Button.SettingsBtn">
                <Setter Property="Background" Value="#505050"/>
                <Setter Property="Foreground" Value="White"/>
                <Setter Property="FontSize" Value="12"/>
                <Setter Property="Padding" Value="8,2"/>
            </Style>
            <Style Selector="Button.SettingsBtn:pointerover">
                <Setter Property="Background" Value="#606060"/>
            </Style>
        </Grid.Styles>
        <!-- Main Content Area -->
        <Grid Grid.Row="0" ColumnDefinitions="Auto,*">

            <!-- Sidebar (Column 0) -->
            <!-- Background 改用動態系統筆刷，深色模式下會變成舒適的深灰色 -->
            <Border Grid.Column="0" 
                    MinWidth="280"
                    MaxWidth="420"
                    Background="{DynamicResource SystemControlBackgroundChromeMediumLowBrush}" 
                    BorderBrush="{DynamicResource SystemControlForegroundBaseLowBrush}" 
                    BorderThickness="0,0,1,0">
                <Grid RowDefinitions="*,Auto" Margin="12">
                    <ScrollViewer Grid.Row="0">
                        <StackPanel Spacing="16">
                            <!-- Step 1: Monitor -->
                            <StackPanel Spacing="8">
                                <!-- 卡片背景改用 AltHighBrush，淺色是白，深色是黑/深灰 -->
                                <Border Background="{DynamicResource SystemControlBackgroundAltHighBrush}" 
                                        CornerRadius="6" Padding="12" BoxShadow="0 1 3 0 #20000000">
                                    <StackPanel Spacing="10">
                                        <StackPanel Orientation="Horizontal" Spacing="6">
                                            <TextBlock Text="1." Foreground="#007ACC" FontWeight="Bold"/>
                                            <TextBlock Text="{x:Static p:Resources.Main_Step1_Title}" FontWeight="Bold" Foreground="#007ACC"/>
                                        </StackPanel>
                                        
                                        <ComboBox ItemsSource="{Binding Monitors}" 
                                                  SelectedItem="{Binding SelectedMonitor}"
                                                  HorizontalAlignment="Stretch">
                                            <ComboBox.ItemTemplate>
                                                <DataTemplate>
                                                    <!-- 移除強制黑色，讓它自動適應 -->
                                                    <TextBlock Text="{Binding Name}"/>
                                                </DataTemplate>
                                            </ComboBox.ItemTemplate>
                                        </ComboBox>

                                        <!-- Removed the Switch Test button, simplified to only Refresh Monitor button -->
                                        <Button Content="{x:Static p:Resources.Main_Btn_Refresh}" 
                                                Command="{Binding RefreshMonitorsCommand}" 
                                                HorizontalAlignment="Stretch" 
                                                HorizontalContentAlignment="Center"/>
                                    </StackPanel>
                                </Border>
                            </StackPanel>

                            <!-- Step 2: Trigger -->
                            <StackPanel Spacing="8">
                                <Border Background="{DynamicResource SystemControlBackgroundAltHighBrush}" 
                                        CornerRadius="6" Padding="12" BoxShadow="0 1 3 0 #20000000">
                                    <StackPanel Spacing="10">
                                        <StackPanel Orientation="Horizontal" Spacing="6">
                                            <TextBlock Text="2." Foreground="#007ACC" FontWeight="Bold"/>
                                            <TextBlock Text="{x:Static p:Resources.Main_Step2_Title}" FontWeight="Bold" Foreground="#007ACC"/>
                                        </StackPanel>

                                        <ListBox ItemsSource="{Binding UsbTargets}" 
                                                 SelectedItem="{Binding SelectedUsbDevice}"
                                                 Height="120" Background="Transparent" 
                                                 BorderThickness="1" 
                                                 BorderBrush="{DynamicResource SystemControlForegroundBaseLowBrush}" 
                                                 CornerRadius="4">
                                            <ListBox.ItemTemplate>
                                                <DataTemplate>
                                                    <StackPanel Spacing="2">
                                                        <!-- 移除強制顏色，改用 Opacity 來做層級區分 -->
                                                        <TextBlock Text="{Binding Name}" FontWeight="Bold" FontSize="12"/>
                                                        <StackPanel Orientation="Horizontal" Spacing="4">
                                                            <TextBlock Text="{Binding Vid}" FontSize="11" Opacity="0.6"/>
                                                            <TextBlock Text=":" FontSize="11" Opacity="0.6"/>
                                                            <TextBlock Text="{Binding Pid}" FontSize="11" Opacity="0.6"/>
                                                        </StackPanel>
                                                    </StackPanel>
                                                </DataTemplate>
                                            </ListBox.ItemTemplate>
                                        </ListBox>
                                        
                                        <CheckBox Content="{x:Static p:Resources.Main_Check_ShowAllUsbEvents}" 
                                                  IsChecked="{Binding ShowAllUsbEvents}" 
                                                  FontSize="12"
                                                  Opacity="0.8"/>
                                    </StackPanel>
                                </Border>
                            </StackPanel>

                            <!-- Step 3: Actions -->
                            <StackPanel Spacing="8">
                                <Border Background="{DynamicResource SystemControlBackgroundAltHighBrush}" 
                                        CornerRadius="6" Padding="12" BoxShadow="0 1 3 0 #20000000">
                                    <StackPanel Spacing="10">
                                        <StackPanel Orientation="Horizontal" Spacing="6">
                                            <TextBlock Text="3." Foreground="#007ACC" FontWeight="Bold"/>
                                            <TextBlock Text="{x:Static p:Resources.Main_Step3_Title}" FontWeight="Bold" Foreground="#007ACC"/>
                                        </StackPanel>

                                        <Grid ColumnDefinitions="Auto,*,Auto" RowDefinitions="Auto,Auto" RowSpacing="10">
                                            <!-- Row 0: Added -->
                                            <TextBlock Grid.Row="0" Grid.Column="0" Text="{x:Static p:Resources.Main_Label_OnAdded}" VerticalAlignment="Center" Margin="0,0,8,0"/>
                                            <ComboBox Grid.Row="0" Grid.Column="1" 
                                                      HorizontalAlignment="Stretch"
                                                      ItemsSource="{Binding ActionInputSourceOptions}" 
                                                      SelectedItem="{Binding OnAddedInputSourceOption}">
                                                 <ComboBox.ItemTemplate>
                                                    <DataTemplate>
                                                        <TextBlock Text="{Binding Name}"/>
                                                    </DataTemplate>
                                                </ComboBox.ItemTemplate>
                                            </ComboBox>
                                            <Button Grid.Row="0" Grid.Column="2" Margin="8,0,0,0"
                                                    HorizontalAlignment="Stretch"
                                                    HorizontalContentAlignment="Center"
                                                    Content="{x:Static p:Resources.Main_Btn_Test}"
                                                    Command="{Binding TestInputSourceCommand}"
                                                    CommandParameter="{Binding OnAddedInputSourceOption}"
                                                    ToolTip.Tip="{x:Static p:Resources.Main_Tooltip_TestInputSource}"/>

                                            <!-- Row 1: Removed -->
                                            <TextBlock Grid.Row="1" Grid.Column="0" Text="{x:Static p:Resources.Main_Label_OnRemoved}" VerticalAlignment="Center" Margin="0,0,8,0"/>
                                            <ComboBox Grid.Row="1" Grid.Column="1" 
                                                      HorizontalAlignment="Stretch"
                                                      ItemsSource="{Binding ActionInputSourceOptions}" 
                                                      SelectedItem="{Binding OnRemovedInputSourceOption}">
                                                 <ComboBox.ItemTemplate>
                                                    <DataTemplate>
                                                        <TextBlock Text="{Binding Name}"/>
                                                    </DataTemplate>
                                                </ComboBox.ItemTemplate>
                                            </ComboBox>
                                            <Button Grid.Row="1" Grid.Column="2" Margin="8,0,0,0"
                                                    HorizontalAlignment="Stretch"
                                                    HorizontalContentAlignment="Center"
                                                    Content="{x:Static p:Resources.Main_Btn_Test}"
                                                    Command="{Binding TestInputSourceCommand}"
                                                    CommandParameter="{Binding OnRemovedInputSourceOption}"
                                                    ToolTip.Tip="{x:Static p:Resources.Main_Tooltip_TestInputSource}"/>
                                        </Grid>
                                    </StackPanel>
                                </Border>
                            </StackPanel>

                            <!-- Add Rule Button -->
                                <Button Content="{x:Static p:Resources.Main_Btn_AddRule}" 
                                    Command="{Binding AddRuleFromSelectionCommand}" 
                                    HorizontalAlignment="Stretch" 
                                    HorizontalContentAlignment="Center"
                                    Background="#007ACC" 
                                    Foreground="White"
                                    FontWeight="Bold"
                                    Padding="10"/>
                        </StackPanel>
                    </ScrollViewer>

                    <!-- Bottom Functional Area -->
                    <StackPanel Grid.Row="1" Margin="0,12,0,0">
                        <CheckBox Content="{x:Static p:Resources.Main_Check_EnableMonitoring}" IsChecked="{Binding IsMonitoringEnabled}"/>
                        <CheckBox Content="{x:Static p:Resources.Main_Check_MinimizeToTray}" IsChecked="{Binding MinimizeToTrayOnClose}" Margin="0,6,0,0"/>
                    </StackPanel>
                </Grid>
            </Border>

            <!-- Content Area (Column 1) -->
            <Grid Grid.Column="1" RowDefinitions="Auto,*" Margin="20">
                
                <!-- Header -->
                <Grid Grid.Row="0" ColumnDefinitions="*,Auto" Margin="0,0,0,10">
                    <TextBlock Grid.Column="0" Text="{x:Static p:Resources.Main_Header_ActiveRules}" FontSize="18" FontWeight="Bold" VerticalAlignment="Center" Foreground="#007ACC"/>
                    <Button Grid.Column="1" Content="{x:Static p:Resources.Main_Btn_OpenConfigFolder}" Command="{Binding OpenConfigFolderCommand}" Padding="8,4"/>
                </Grid>
                
                <!-- DataGrid -->
                <!-- 移除了 Background="White" 和 Foreground="Black"，現在表格會自動黑底白字 -->
                <DataGrid Grid.Row="1" 
                          ItemsSource="{Binding RulesDisplay}" 
                          AutoGenerateColumns="False" 
                          IsReadOnly="True"
                          GridLinesVisibility="Horizontal"
                          HeadersVisibility="Column"
                          BorderThickness="1" 
                          BorderBrush="{DynamicResource SystemControlForegroundBaseLowBrush}">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="{x:Static p:Resources.Main_GridHeader_Vid}" Binding="{Binding Vid}" Width="Auto"/>
                        <DataGridTextColumn Header="{x:Static p:Resources.Main_GridHeader_Pid}" Binding="{Binding Pid}" Width="Auto"/>
                        <DataGridTextColumn Header="{x:Static p:Resources.Main_GridHeader_Monitor}" Binding="{Binding MonitorName}" Width="*"/>
                        <DataGridTextColumn Header="{x:Static p:Resources.Main_GridHeader_OnAdded}" Binding="{Binding OnAddedLabel}" Width="Auto"/>
                        <DataGridTextColumn Header="{x:Static p:Resources.Main_GridHeader_OnRemoved}" Binding="{Binding OnRemovedLabel}" Width="Auto"/>
                        <DataGridTemplateColumn Header="{x:Static p:Resources.Main_GridHeader_Actions}" Width="Auto">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <Button Content="{x:Static p:Resources.Main_Btn_Delete}" 
                                            Command="{Binding $parent[Window].DataContext.DeleteRuleCommand}" 
                                            CommandParameter="{Binding Rule}"
                                            Foreground="#FF453A" 
                                            Background="Transparent" 
                                            BorderThickness="0"
                                            HorizontalAlignment="Center"/>
                                            <!-- 深色模式下，稍微調亮一點的紅色比較好讀 (#FF453A) -->
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>
                    </DataGrid.Columns>
                </DataGrid>
            </Grid>
        </Grid>

        <!-- Bottom Status & Debug -->
        <StackPanel Grid.Row="1" Background="#007ACC">
            <!-- Status Bar -->
            <Grid ColumnDefinitions="Auto,*,Auto" Margin="12,6">
                <!-- Status text -->
                <TextBlock Grid.Column="0" Text="{Binding Status}" Foreground="White" FontWeight="SemiBold"/>
                
                <!-- Debug Toggle -->
                <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="8">
                     <Button Classes="SettingsBtn"
                             Content="{x:Static p:Resources.Main_Btn_Settings}"
                             Command="{Binding OpenSettingsCommand}" />
                    <CheckBox Content="{x:Static p:Resources.Main_Debug_DebugMode}" IsChecked="{Binding IsDebugMode}" Foreground="White"/>
                </StackPanel>
            </Grid>

            <!-- Debug Window (Collapsible) -->
            <Grid IsVisible="{Binding IsDebugMode}" Background="#2D2D2D" Height="150">
                 <Grid.RowDefinitions>
                     <RowDefinition Height="Auto"/>
                     <RowDefinition Height="*"/>
                 </Grid.RowDefinitions>
                 
                 <!-- Toolbar for Debug -->
                 <StackPanel Grid.Row="0" Orientation="Horizontal" Spacing="8" Margin="8,4" HorizontalAlignment="Right">
                      <Button Content="{x:Static p:Resources.Main_Debug_Copy}" Command="{Binding CopyDebugLogCommand}" FontSize="12" Padding="6,2" Background="#444" Foreground="White"/>
                      <Button Content="{x:Static p:Resources.Main_Debug_Save}" Command="{Binding SaveDebugLogCommand}" FontSize="12" Padding="6,2" Background="#444" Foreground="White"/>
                 </StackPanel>

                 <TextBox Grid.Row="1" 
                          Text="{Binding DebugLogText}" 
                          Background="Transparent" 
                          Foreground="#E0E0E0" 
                          BorderThickness="0" 
                          IsReadOnly="True" 
                          TextWrapping="Wrap" 
                          AcceptsReturn="True"
                          FontFamily="Consolas, Monospace"
                          FontSize="12"
                          Margin="8"/>
            </Grid>
        </StackPanel>
    </Grid>
</Window>
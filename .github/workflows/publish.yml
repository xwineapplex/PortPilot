name: Publish PortPilot

on:
  push:
    tags:
      - 'v*'
  # Allow manual trigger for ad-hoc runs.
  # Use "Run workflow" in GitHub Actions without pushing tags.
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-release:
    name: Build All Platforms
    runs-on: ubuntu-latest # Run all builds on Linux for speed and consistency.

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x'

    # --- Windows Builds (build on Linux) ---
    
    # 1. Windows Standalone (include runtime)
    # Set /p:SelfContained=true to force inclusion.
    - name: Build Windows Standalone
      run: |
        dotnet publish PortPilot-Project.csproj -c Release -r win-x64 /p:SelfContained=true /p:PublishSingleFile=true /p:PublishTrimmed=false /p:AssemblyName=PortPilot -o ./publish/win-standalone

    # 2. Windows Dependent (exclude runtime)
    # Set /p:SelfContained=false to force exclusion.
    - name: Build Windows Dependent
      run: |
        dotnet publish PortPilot-Project.csproj -c Release -r win-x64 /p:SelfContained=false /p:PublishSingleFile=true /p:PublishTrimmed=false /p:AssemblyName=PortPilot -o ./publish/win-dependent

    # --- Linux Builds ---

    # 3. Linux Standalone (include runtime)
    - name: Build Linux Standalone
      run: |
        dotnet publish PortPilot-Project.csproj -c Release -r linux-x64 /p:SelfContained=true /p:PublishSingleFile=true /p:PublishTrimmed=false /p:AssemblyName=PortPilot -o ./publish/linux-standalone

    # 4. Linux Dependent (exclude runtime)
    - name: Build Linux Dependent
      run: |
        dotnet publish PortPilot-Project.csproj -c Release -r linux-x64 /p:SelfContained=false /p:PublishSingleFile=true /p:PublishTrimmed=false /p:AssemblyName=PortPilot -o ./publish/linux-dependent

    # --- Packaging (package on Linux) ---

    # Use Linux zip to package Windows artifacts.
    - name: Pack Windows Archives
      run: |
        # Package from the target directory to avoid extra nesting.
        cd ./publish/win-standalone && zip -r ../../PortPilot-win-x64-standalone.zip ./*
        cd ../../
        cd ./publish/win-dependent && zip -r ../../PortPilot-win-x64-dependent.zip ./*
        cd ../../

    # Use tar to package Linux artifacts.
    - name: Pack Linux Archives
      run: |
        # Ensure executable permissions.
        chmod +x ./publish/linux-standalone/PortPilot
        chmod +x ./publish/linux-dependent/PortPilot
        
        # Create archives.
        tar -czvf PortPilot-linux-x64-standalone.tar.gz -C ./publish/linux-standalone .
        tar -czvf PortPilot-linux-x64-dependent.tar.gz -C ./publish/linux-dependent .

    # --- Release ---
    # Run this step only for tags; manual runs do not create a release.
    # Use the build steps alone when validating compilation.
    - name: Upload Release Assets
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        draft: true
        prerelease: false
        body: |
          ## ğŸš€ What's New / æ›´æ–°å…§å®¹
          
          <!-- è«‹åœ¨æ­¤è™•åˆ—å‡ºè®Šæ›´é» (List your changes here) -->
          - âœ¨ New Features: 
          - ğŸ› Bug Fixes: 
          
          ---
          ### ğŸ“¥ Download Guide / ä¸‹è¼‰æŒ‡å¼•
          
          **Windows Users:**
          - ğŸ“¦ `PortPilot-win-x64-standalone.zip`: **Recommended**. Includes .NET Runtime. (å…§å« Runtimeï¼Œéš¨é–‹å³ç”¨ï¼Œæª”æ¡ˆè¼ƒå¤§)
          - ğŸ”§ `PortPilot-win-x64-dependent.zip`: Requires [.NET 10 Desktop Runtime](https://dotnet.microsoft.com/download/dotnet/10.0). (æª”æ¡ˆæ¥µå°ï¼Œéœ€å…ˆå®‰è£ .NET 10)

          **Linux Users:**
          - ğŸ“¦ `PortPilot-linux-x64-standalone.tar.gz`: **Recommended**. Includes Runtime. (å…§å« Runtimeï¼Œæª”æ¡ˆè¼ƒå¤§)
          - ğŸ”§ `PortPilot-linux-x64-dependent.tar.gz`: Requires .NET 10 Runtime. (æª”æ¡ˆæ¥µå°ï¼Œéœ€å®‰è£ .NET 10)

        files: |
          ./PortPilot-win-x64-standalone.zip
          ./PortPilot-win-x64-dependent.zip
          ./PortPilot-linux-x64-standalone.tar.gz
          ./PortPilot-linux-x64-dependent.tar.gz
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
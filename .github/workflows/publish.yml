name: Publish PortPilot

on:
  push:
    tags:
      - 'v*'

jobs:
  build-and-release:
    name: Build for ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: windows-latest
            rid: win-x64
            archive_ext: zip
          - os: ubuntu-latest
            rid: linux-x64
            archive_ext: tar.gz

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x'

    - name: Restore Dependencies
      run: dotnet restore PortPilot-Project.csproj -r ${{ matrix.rid }}

    - name: Publish Standalone
      run: |
        dotnet publish PortPilot-Project.csproj -c Release -r ${{ matrix.rid }} --self-contained true --no-restore -p:PublishSingleFile=true -p:PublishTrimmed=false -p:AssemblyName=PortPilot -o ./publish/standalone

    - name: Publish Framework Dependent
      run: |
        dotnet publish PortPilot-Project.csproj -c Release -r ${{ matrix.rid }} --self-contained false --no-restore -p:PublishSingleFile=true -p:PublishTrimmed=false -p:AssemblyName=PortPilot -o ./publish/dependent

    - name: Pack Windows Archives
      if: matrix.os == 'windows-latest'
      run: |
        Compress-Archive -Path ./publish/standalone/* -DestinationPath ./PortPilot-${{ matrix.rid }}-standalone.zip
        Compress-Archive -Path ./publish/dependent/* -DestinationPath ./PortPilot-${{ matrix.rid }}-dependent.zip

    - name: Pack Linux Archives
      if: matrix.os == 'ubuntu-latest'
      run: |
        # å› ç‚ºä¸Šé¢åŠ äº† AssemblyName=PortPilotï¼Œé€™è£¡å°±èƒ½æ­£ç¢ºæ‰¾åˆ°æª”æ¡ˆäº†
        chmod +x ./publish/standalone/PortPilot
        chmod +x ./publish/dependent/PortPilot
        
        tar -czvf PortPilot-${{ matrix.rid }}-standalone.tar.gz -C ./publish/standalone PortPilot
        tar -czvf PortPilot-${{ matrix.rid }}-dependent.tar.gz -C ./publish/dependent PortPilot

    - name: Upload Release Assets
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        draft: true
        prerelease: false
        body: |
          ## ğŸš€ PortPilot Update
          
          *(Write your changelog here...)*
          
          ---
          ### ğŸ“¥ ä¸‹è¼‰æŒ‡å¼• (Download Guide)
          
          **Windows Users:**
          - ğŸ“¦ `PortPilot-win-x64-standalone.zip`: **Recommended.** Download, extract, and run (includes the .NET runtime).
          - ğŸ”§ `PortPilot-win-x64-dependent.zip`: Requires installing the [.NET 10 Desktop Runtime](https://dotnet.microsoft.com/download/dotnet/10.0).

          **Linux Users:**
          - ğŸ“¦ `PortPilot-linux-x64-standalone.tar.gz`: **Recommended.** Includes the runtime.
          - ğŸ”§ `PortPilot-linux-x64-dependent.tar.gz`: Requires installing the .NET 10 runtime.

        files: |
          ./PortPilot-${{ matrix.rid }}-standalone.${{ matrix.archive_ext }}
          ./PortPilot-${{ matrix.rid }}-dependent.${{ matrix.archive_ext }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}